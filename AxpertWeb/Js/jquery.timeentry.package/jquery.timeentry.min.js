(function(h){function g(){this._disabledInputs=[];this.regional=[];this.regional[""]={show24Hours:false,separator:":",ampmPrefix:"",ampmNames:["AM","PM"],spinnerTexts:["Now","Previous field","Next field","Increment","Decrement"]};this._defaults={appendText:"",showSeconds:false,timeSteps:[1,1,1],initialField:0,noSeparatorEntry:false,useMouseWheel:true,defaultTime:null,minTime:null,maxTime:null,spinnerImage:"spinnerDefault.png",spinnerSize:[20,20,8],spinnerBigImage:"",spinnerBigSize:[40,40,16],spinnerIncDecOnly:false,spinnerRepeat:[500,250],beforeShow:null,beforeSetTime:null};h.extend(this._defaults,this.regional[""])}h.extend(g.prototype,{markerClassName:"hasTimeEntry",propertyName:"timeEntry",_wrapClass:"timeEntry_wrap",_appendClass:"timeEntry_append",_controlClass:"timeEntry_control",_expandClass:"timeEntry_expand",setDefaults:function(a){h.extend(this._defaults,a||{});return this},_attachPlugin:function(a,c){var d=h(a);if(d.hasClass(this.markerClassName)){return}var b={options:h.extend({},this._defaults,c),input:d,_field:0,_selectedHour:0,_selectedMinute:0,_selectedSecond:0};d.data(this.propertyName,b).addClass(this.markerClassName).bind("focus."+this.propertyName,this._doFocus).bind("blur."+this.propertyName,this._doBlur).bind("click."+this.propertyName,this._doClick).bind("keydown."+this.propertyName,this._doKeyDown).bind("keypress."+this.propertyName,this._doKeyPress).wrap('<span class="'+this._wrapClass+'"></span>');if(h.browser.mozilla){d.bind("input."+this.propertyName,function(e){i._parseTime(b)})}if(h.browser.msie){d.bind("paste."+this.propertyName,function(e){setTimeout(function(){i._parseTime(b)},1)})}this._optionPlugin(a,c)},_optionPlugin:function(b,m,c){b=h(b);var d=b.data(this.propertyName);if(!m||(typeof m=="string"&&c==null)){var n=m;m=(d||{}).options;return(m&&n?m[n]:m)}if(!b.hasClass(this.markerClassName)){return}m=m||{};if(typeof m=="string"){var n=m;m={};m[n]=c}var e=this._extractTime(d);h.extend(d.options,m);if(e){this._setTime(d,new Date(0,0,0,e[0],e[1],e[2]))}b.next("span."+this._appendClass).remove();b.parent().find("span."+this._controlClass).remove();if(h.fn.mousewheel){b.unmousewheel()}var a=(!d.options.spinnerImage?null:h('<span class="'+this._controlClass+'" style="display: inline-block; background: url(\''+d.options.spinnerImage+"') 0 0 no-repeat; width: "+d.options.spinnerSize[0]+"px; height: "+d.options.spinnerSize[1]+"px;"+(h.browser.mozilla&&h.browser.version<"1.9"?" padding-left: "+d.options.spinnerSize[0]+"px; padding-bottom: "+(d.options.spinnerSize[1]-18)+"px;":"")+'"></span>'));b.after(d.options.appendText?'<span class="'+this._appendClass+'">'+d.options.appendText+"</span>":"").after(a||"");if(d.options.useMouseWheel&&h.fn.mousewheel){b.mousewheel(this._doMouseWheel)}if(a){a.mousedown(this._handleSpinner).mouseup(this._endSpinner).mouseover(this._expandSpinner).mouseout(this._endSpinner).mousemove(this._describeSpinner)}},_enablePlugin:function(a){this._enableDisable(a,false)},_disablePlugin:function(a){this._enableDisable(a,true)},_enableDisable:function(a,c){var b=h.data(a,this.propertyName);if(!b){return}a.disabled=c;if(a.nextSibling&&a.nextSibling.nodeName.toLowerCase()=="span"){i._changeSpinner(b,a.nextSibling,(c?5:-1))}i._disabledInputs=h.map(i._disabledInputs,function(d){return(d==a?null:d)});if(c){i._disabledInputs.push(a)}},_isDisabledPlugin:function(a){return h.inArray(a,this._disabledInputs)>-1},_destroyPlugin:function(a){a=h(a);if(!a.hasClass(this.markerClassName)){return}a.removeClass(this.markerClassName).removeData(this.propertyName).unbind("."+this.propertyName);if(h.fn.mousewheel){a.unmousewheel()}this._disabledInputs=h.map(this._disabledInputs,function(b){return(b==a[0]?null:b)});a.parent().replaceWith(a)},_setTimePlugin:function(a,b){var c=h.data(a,this.propertyName);if(c){if(b===null||b===""){c.input.val("")}else{this._setTime(c,b?(typeof b=="object"?new Date(b.getTime()):b):null)}}},_getTimePlugin:function(a){var b=h.data(a,this.propertyName);var c=(b?this._extractTime(b):null);return(!c?null:new Date(0,0,0,c[0],c[1],c[2]))},_getOffsetPlugin:function(a){var b=h.data(a,this.propertyName);var c=(b?this._extractTime(b):null);return(!c?0:(c[0]*3600+c[1]*60+c[2])*1000)},_doFocus:function(a){var c=(a.nodeName&&a.nodeName.toLowerCase()=="input"?a:this);if(i._lastInput==c||i._isDisabledPlugin(c)){i._focussed=false;return}var b=h.data(c,i.propertyName);i._focussed=true;i._lastInput=c;i._blurredInput=null;h.extend(b.options,(h.isFunction(b.options.beforeShow)?b.options.beforeShow.apply(c,[c]):{}));i._parseTime(b);setTimeout(function(){i._showField(b)},10)},_doBlur:function(a){i._blurredInput=i._lastInput;i._lastInput=null},_doClick:function(s){var b=s.target;var p=h.data(b,i.propertyName);if(!i._focussed){var a=p.options.separator.length+2;p._field=0;if(b.selectionStart!=null){for(var c=0;c<=Math.max(1,p._secondField,p._ampmField);c++){var r=(c!=p._ampmField?(c*a)+2:(p._ampmField*a)+p.options.ampmPrefix.length+p.options.ampmNames[0].length);p._field=c;if(b.selectionStart<r){break}}}else{if(b.createTextRange){var t=h(s.srcElement);var e=b.createTextRange();var d=function(k){return{thin:2,medium:4,thick:6}[k]||k};var q=s.clientX+document.documentElement.scrollLeft-(t.offset().left+parseInt(d(t.css("border-left-width")),10))-e.offsetLeft;for(var c=0;c<=Math.max(1,p._secondField,p._ampmField);c++){var r=(c!=p._ampmField?(c*a)+2:(p._ampmField*a)+p.options.ampmPrefix.length+p.options.ampmNames[0].length);e.collapse();e.moveEnd("character",r);p._field=c;if(q<e.boundingWidth){break}}}}}i._showField(p);i._focussed=false},_doKeyDown:function(b){if(b.keyCode>=48){return true}var a=h.data(b.target,i.propertyName);switch(b.keyCode){case 9:return(b.shiftKey?i._changeField(a,-1,true):i._changeField(a,+1,true));case 35:if(b.ctrlKey){i._setValue(a,"")}else{a._field=Math.max(1,a._secondField,a._ampmField);i._adjustField(a,0)}break;case 36:if(b.ctrlKey){i._setTime(a)}else{a._field=0;i._adjustField(a,0)}break;case 37:i._changeField(a,-1,false);break;case 38:i._adjustField(a,+1);break;case 39:i._changeField(a,+1,false);break;case 40:i._adjustField(a,-1);break;case 46:i._setValue(a,"");break;default:return true}return false},_doKeyPress:function(b){var c=String.fromCharCode(b.charCode==undefined?b.keyCode:b.charCode);if(c<" "){return true}var a=h.data(b.target,i.propertyName);i._handleKeyPress(a,c);return false},_doMouseWheel:function(c,a){if(i._isDisabledPlugin(c.target)){return}a=(h.browser.opera?-a/Math.abs(a):(h.browser.safari?a/Math.abs(a):a));var b=h.data(c.target,i.propertyName);b.input.focus();if(!b.input.val()){i._parseTime(b)}i._adjustField(b,a);c.preventDefault()},_expandSpinner:function(e){var a=i._getSpinnerTarget(e);var c=h.data(i._getInput(a),i.propertyName);if(i._isDisabledPlugin(c.input[0])){return}if(c.options.spinnerBigImage){c._expanded=true;var b=h(a).offset();var d=null;h(a).parents().each(function(){var l=h(this);if(l.css("position")=="relative"||l.css("position")=="absolute"){d=l.offset()}return !d});h('<div class="'+i._expandClass+'" style="position: absolute; left: '+(b.left-(c.options.spinnerBigSize[0]-c.options.spinnerSize[0])/2-(d?d.left:0))+"px; top: "+(b.top-(c.options.spinnerBigSize[1]-c.options.spinnerSize[1])/2-(d?d.top:0))+"px; width: "+c.options.spinnerBigSize[0]+"px; height: "+c.options.spinnerBigSize[1]+"px; background: transparent url("+c.options.spinnerBigImage+') no-repeat 0px 0px; z-index: 10;"></div>').mousedown(i._handleSpinner).mouseup(i._endSpinner).mouseout(i._endExpand).mousemove(i._describeSpinner).insertAfter(a)}},_getInput:function(a){return h(a).siblings("."+i.markerClassName)[0]},_describeSpinner:function(c){var a=i._getSpinnerTarget(c);var b=h.data(i._getInput(a),i.propertyName);a.title=b.options.spinnerTexts[i._getSpinnerRegion(b,c)]},_handleSpinner:function(d){var a=i._getSpinnerTarget(d);var e=i._getInput(a);if(i._isDisabledPlugin(e)){return}if(e==i._blurredInput){i._lastInput=e;i._blurredInput=null}var c=h.data(e,i.propertyName);i._doFocus(e);var b=i._getSpinnerRegion(c,d);i._changeSpinner(c,a,b);i._actionSpinner(c,b);i._timer=null;i._handlingSpinner=true;if(b>=3&&c.options.spinnerRepeat[0]){i._timer=setTimeout(function(){i._repeatSpinner(c,b)},c.options.spinnerRepeat[0]);h(a).one("mouseout",i._releaseSpinner).one("mouseup",i._releaseSpinner)}},_actionSpinner:function(b,a){if(!b.input.val()){i._parseTime(b)}switch(a){case 0:this._setTime(b);break;case 1:this._changeField(b,-1,false);break;case 2:this._changeField(b,+1,false);break;case 3:this._adjustField(b,+1);break;case 4:this._adjustField(b,-1);break}},_repeatSpinner:function(b,a){if(!i._timer){return}i._lastInput=i._blurredInput;this._actionSpinner(b,a);this._timer=setTimeout(function(){i._repeatSpinner(b,a)},b.options.spinnerRepeat[1])},_releaseSpinner:function(a){clearTimeout(i._timer);i._timer=null},_endExpand:function(c){i._timer=null;var a=i._getSpinnerTarget(c);var d=i._getInput(a);var b=h.data(d,i.propertyName);h(a).remove();b._expanded=false},_endSpinner:function(c){i._timer=null;var a=i._getSpinnerTarget(c);var d=i._getInput(a);var b=h.data(d,i.propertyName);if(!i._isDisabledPlugin(d)){i._changeSpinner(b,a,-1)}if(i._handlingSpinner){i._lastInput=i._blurredInput}if(i._lastInput&&i._handlingSpinner){i._showField(b)}i._handlingSpinner=false},_getSpinnerTarget:function(a){return a.target||a.srcElement},_getSpinnerRegion:function(q,u){var a=this._getSpinnerTarget(u);var e=(h.browser.opera||h.browser.safari?i._findPos(a):h(a).offset());var t=(h.browser.safari?i._findScroll(a):[document.documentElement.scrollLeft||document.body.scrollLeft,document.documentElement.scrollTop||document.body.scrollTop]);var s=(q.options.spinnerIncDecOnly?99:u.clientX+t[0]-e.left-(h.browser.msie?2:0));var d=u.clientY+t[1]-e.top-(h.browser.msie?2:0);var c=q.options[q._expanded?"spinnerBigSize":"spinnerSize"];var b=(q.options.spinnerIncDecOnly?99:c[0]-1-s);var v=c[1]-1-d;if(c[2]>0&&Math.abs(s-b)<=c[2]&&Math.abs(d-v)<=c[2]){return 0}var r=Math.min(s,d,b,v);return(r==s?1:(r==b?2:(r==d?3:4)))},_changeSpinner:function(c,a,b){h(a).css("background-position","-"+((b+1)*c.options[c._expanded?"spinnerBigSize":"spinnerSize"][0])+"px 0px")},_findPos:function(a){var b=curTop=0;if(a.offsetParent){b=a.offsetLeft;curTop=a.offsetTop;while(a=a.offsetParent){var c=b;b+=a.offsetLeft;if(b<0){b=c}curTop+=a.offsetTop}}return{left:b,top:curTop}},_findScroll:function(b){var c=false;h(b).parents().each(function(){c|=h(this).css("position")=="fixed"});if(c){return[0,0]}var a=b.scrollLeft;var d=b.scrollTop;while(b=b.parentNode){a+=b.scrollLeft||0;d+=b.scrollTop||0}return[a,d]},_parseTime:function(a){var b=this._extractTime(a);if(b){a._selectedHour=b[0];a._selectedMinute=b[1];a._selectedSecond=b[2]}else{var c=this._constrainTime(a);a._selectedHour=c[0];a._selectedMinute=c[1];a._selectedSecond=(a.options.showSeconds?c[2]:0)}a._secondField=(a.options.showSeconds?2:-1);a._ampmField=(a.options.show24Hours?-1:(a.options.showSeconds?3:2));a._lastChr="";a._field=Math.max(0,Math.min(Math.max(1,a._secondField,a._ampmField),a.options.initialField));if(a.input.val()!=""){this._showTime(a)}},_extractTime:function(b,c){c=c||b.input.val();var d=c.split(b.options.separator);if(b.options.separator==""&&c!=""){d[0]=c.substring(0,2);d[1]=c.substring(2,4);d[2]=c.substring(4,6)}if(d.length>=2){var e=!b.options.show24Hours&&(c.indexOf(b.options.ampmNames[0])>-1);var p=!b.options.show24Hours&&(c.indexOf(b.options.ampmNames[1])>-1);var o=parseInt(d[0],10);o=(isNaN(o)?0:o);o=((e||p)&&o==12?0:o)+(p?12:0);var a=parseInt(d[1],10);a=(isNaN(a)?0:a);var n=(d.length>=3?parseInt(d[2],10):0);n=(isNaN(n)||!b.options.showSeconds?0:n);return this._constrainTime(b,[o,a,n])}return null},_constrainTime:function(a,m){var b=(m!=null);if(!b){var e=this._determineTime(a.options.defaultTime,a)||new Date();m=[e.getHours(),e.getMinutes(),e.getSeconds()]}var c=false;for(var d=0;d<a.options.timeSteps.length;d++){if(c){m[d]=0}else{if(a.options.timeSteps[d]>1){m[d]=Math.round(m[d]/a.options.timeSteps[d])*a.options.timeSteps[d];c=true}}}return m},_showTime:function(a){var b=(this._formatNumber(a.options.show24Hours?a._selectedHour:((a._selectedHour+11)%12)+1)+a.options.separator+this._formatNumber(a._selectedMinute)+(a.options.showSeconds?a.options.separator+this._formatNumber(a._selectedSecond):"")+(a.options.show24Hours?"":a.options.ampmPrefix+a.options.ampmNames[(a._selectedHour<12?0:1)]));this._setValue(a,b);this._showField(a)},_showField:function(b){var c=b.input[0];if(b.input.is(":hidden")||i._lastInput!=c){return}var l=b.options.separator.length+2;var a=(b._field!=b._ampmField?(b._field*l):(b._ampmField*l)-b.options.separator.length+b.options.ampmPrefix.length);var e=a+(b._field!=b._ampmField?2:b.options.ampmNames[0].length);if(c.setSelectionRange){c.setSelectionRange(a,e)}else{if(c.createTextRange){var d=c.createTextRange();d.moveStart("character",a);d.moveEnd("character",e-b.input.val().length);d.select()}}if(!c.disabled){c.focus()}},_formatNumber:function(a){return(a<10?"0":"")+a},_setValue:function(a,b){if(b!=a.input.val()){a.input.val(b).trigger("change")}},_changeField:function(c,a,b){var d=(c.input.val()==""||c._field==(a==-1?0:Math.max(1,c._secondField,c._ampmField)));if(!d){c._field+=a}this._showField(c);c._lastChr="";return(d&&b)},_adjustField:function(b,a){if(b.input.val()==""){a=0}this._setTime(b,new Date(0,0,0,b._selectedHour+(b._field==0?a*b.options.timeSteps[0]:0)+(b._field==b._ampmField?a*12:0),b._selectedMinute+(b._field==1?a*b.options.timeSteps[1]:0),b._selectedSecond+(b._field==b._secondField?a*b.options.timeSteps[2]:0)))},_setTime:function(b,a){a=this._determineTime(a,b);var e=this._constrainTime(b,a?[a.getHours(),a.getMinutes(),a.getSeconds()]:null);a=new Date(0,0,0,e[0],e[1],e[2]);var a=this._normaliseTime(a);var d=this._normaliseTime(this._determineTime(b.options.minTime,b));var c=this._normaliseTime(this._determineTime(b.options.maxTime,b));a=(d&&a<d?d:(c&&a>c?c:a));if(h.isFunction(b.options.beforeSetTime)){a=b.options.beforeSetTime.apply(b.input[0],[this._getTimePlugin(b.input[0]),a,d,c])}b._selectedHour=a.getHours();b._selectedMinute=a.getMinutes();b._selectedSecond=a.getSeconds();this._showTime(b)},_determineTime:function(b,a){var c=function(e){var l=new Date();l.setTime(l.getTime()+e*1000);return l};var d=function(u){var t=i._extractTime(a,u);var w=new Date();var s=(t?t[0]:w.getHours());var v=(t?t[1]:w.getMinutes());var r=(t?t[2]:w.getSeconds());if(!t){var x=/([+-]?[0-9]+)\s*(s|S|m|M|h|H)?/g;var e=x.exec(u);while(e){switch(e[2]||"s"){case"s":case"S":r+=parseInt(e[1],10);break;case"m":case"M":v+=parseInt(e[1],10);break;case"h":case"H":s+=parseInt(e[1],10);break}e=x.exec(u)}}w=new Date(0,0,10,s,v,r,0);if(/^!/.test(u)){if(w.getDate()>10){w=new Date(0,0,10,23,59,59)}else{if(w.getDate()<10){w=new Date(0,0,10,0,0,0)}}}return w};return(b?(typeof b=="string"?d(b):(typeof b=="number"?c(b):b)):null)},_normaliseTime:function(a){if(!a){return null}a.setFullYear(1900);a.setMonth(0);a.setDate(0);return a},_handleKeyPress:function(e,o){if(o==e.options.separator){this._changeField(e,+1,false)}else{if(o>="0"&&o<="9"){var b=parseInt(o,10);var c=parseInt(e._lastChr+o,10);var p=(e._field!=0?e._selectedHour:(e.options.show24Hours?(c<24?c:b):(c>=1&&c<=12?c:(b>0?b:e._selectedHour))%12+(e._selectedHour>=12?12:0)));var q=(e._field!=1?e._selectedMinute:(c<60?c:b));var r=(e._field!=e._secondField?e._selectedSecond:(c<60?c:b));var d=this._constrainTime(e,[p,q,r]);this._setTime(e,new Date(0,0,0,d[0],d[1],d[2]));if(e.options.noSeparatorEntry&&e._lastChr){this._changeField(e,+1,false)}else{e._lastChr=o}}else{if(!e.options.show24Hours){o=o.toLowerCase();if((o==e.options.ampmNames[0].substring(0,1).toLowerCase()&&e._selectedHour>=12)||(o==e.options.ampmNames[1].substring(0,1).toLowerCase()&&e._selectedHour<12)){var a=e._field;e._field=e._ampmField;this._adjustField(e,+1);e._field=a;this._showField(e)}}}}}});var j=["getOffset","getTime","isDisabled"];function f(a,b){if(a=="option"&&(b.length==0||(b.length==1&&typeof b[0]=="string"))){return true}return h.inArray(a,j)>-1}h.fn.timeEntry=function(a){var b=Array.prototype.slice.call(arguments,1);if(f(a,b)){return i["_"+a+"Plugin"].apply(i,[this[0]].concat(b))}return this.each(function(){if(typeof a=="string"){if(!i["_"+a+"Plugin"]){throw"Unknown command: "+a}i["_"+a+"Plugin"].apply(i,[this].concat(b))}else{var c=(h.fn.metadata?h(this).metadata():{});i._attachPlugin(this,h.extend(c,a||{}))}})};var i=h.timeEntry=new g()})(jQuery);