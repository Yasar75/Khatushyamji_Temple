(function(e){function a(){this._disabledInputs=[];this.regional=[];this.regional[""]={show24Hours:false,separator:":",ampmPrefix:"",ampmNames:["AM","PM"],spinnerTexts:["Now","Previous field","Next field","Increment","Decrement"]};this._defaults={appendText:"",showSeconds:false,timeSteps:[1,1,1],initialField:0,noSeparatorEntry:false,useMouseWheel:true,defaultTime:null,minTime:null,maxTime:null,spinnerImage:"spinnerDefault.png",spinnerSize:[20,20,8],spinnerBigImage:"",spinnerBigSize:[40,40,16],spinnerIncDecOnly:false,spinnerRepeat:[500,250],beforeShow:null,beforeSetTime:null};e.extend(this._defaults,this.regional[""])}e.extend(a.prototype,{markerClassName:"hasTimeEntry",propertyName:"timeEntry",_wrapClass:"timeEntry_wrap",_appendClass:"timeEntry_append",_controlClass:"timeEntry_control",_expandClass:"timeEntry_expand",setDefaults:function(f){e.extend(this._defaults,f||{});return this},_attachPlugin:function(i,g){var f=e(i);if(f.hasClass(this.markerClassName)){return}var h={options:e.extend({},this._defaults,g),input:f,_field:0,_selectedHour:0,_selectedMinute:0,_selectedSecond:0};f.data(this.propertyName,h).addClass(this.markerClassName).bind("focus."+this.propertyName,this._doFocus).bind("blur."+this.propertyName,this._doBlur).bind("click."+this.propertyName,this._doClick).bind("keydown."+this.propertyName,this._doKeyDown).bind("keypress."+this.propertyName,this._doKeyPress).wrap('<span class="'+this._wrapClass+'"></span>');if(e.browser.mozilla){f.bind("input."+this.propertyName,function(j){d._parseTime(h)})}if(e.browser.msie){f.bind("paste."+this.propertyName,function(j){setTimeout(function(){d._parseTime(h)},1)})}this._optionPlugin(i,g)},_optionPlugin:function(k,g,j){k=e(k);var i=k.data(this.propertyName);if(!g||(typeof g=="string"&&j==null)){var f=g;g=(i||{}).options;return(g&&f?g[f]:g)}if(!k.hasClass(this.markerClassName)){return}g=g||{};if(typeof g=="string"){var f=g;g={};g[f]=j}var h=this._extractTime(i);e.extend(i.options,g);if(h){this._setTime(i,new Date(0,0,0,h[0],h[1],h[2]))}k.next("span."+this._appendClass).remove();k.parent().find("span."+this._controlClass).remove();if(e.fn.mousewheel){k.unmousewheel()}var l=(!i.options.spinnerImage?null:e('<span class="'+this._controlClass+'" style="display: inline-block; background: url(\''+i.options.spinnerImage+"') 0 0 no-repeat; width: "+i.options.spinnerSize[0]+"px; height: "+i.options.spinnerSize[1]+"px;"+(e.browser.mozilla&&e.browser.version<"1.9"?" padding-left: "+i.options.spinnerSize[0]+"px; padding-bottom: "+(i.options.spinnerSize[1]-18)+"px;":"")+'"></span>'));k.after(i.options.appendText?'<span class="'+this._appendClass+'">'+i.options.appendText+"</span>":"").after(l||"");if(i.options.useMouseWheel&&e.fn.mousewheel){k.mousewheel(this._doMouseWheel)}if(l){l.mousedown(this._handleSpinner).mouseup(this._endSpinner).mouseover(this._expandSpinner).mouseout(this._endSpinner).mousemove(this._describeSpinner)}},_enablePlugin:function(f){this._enableDisable(f,false)},_disablePlugin:function(f){this._enableDisable(f,true)},_enableDisable:function(h,f){var g=e.data(h,this.propertyName);if(!g){return}h.disabled=f;if(h.nextSibling&&h.nextSibling.nodeName.toLowerCase()=="span"){d._changeSpinner(g,h.nextSibling,(f?5:-1))}d._disabledInputs=e.map(d._disabledInputs,function(i){return(i==h?null:i)});if(f){d._disabledInputs.push(h)}},_isDisabledPlugin:function(f){return e.inArray(f,this._disabledInputs)>-1},_destroyPlugin:function(f){f=e(f);if(!f.hasClass(this.markerClassName)){return}f.removeClass(this.markerClassName).removeData(this.propertyName).unbind("."+this.propertyName);if(e.fn.mousewheel){f.unmousewheel()}this._disabledInputs=e.map(this._disabledInputs,function(g){return(g==f[0]?null:g)});f.parent().replaceWith(f)},_setTimePlugin:function(h,g){var f=e.data(h,this.propertyName);if(f){if(g===null||g===""){f.input.val("")}else{this._setTime(f,g?(typeof g=="object"?new Date(g.getTime()):g):null)}}},_getTimePlugin:function(h){var g=e.data(h,this.propertyName);var f=(g?this._extractTime(g):null);return(!f?null:new Date(0,0,0,f[0],f[1],f[2]))},_getOffsetPlugin:function(h){var g=e.data(h,this.propertyName);var f=(g?this._extractTime(g):null);return(!f?0:(f[0]*3600+f[1]*60+f[2])*1000)},_doFocus:function(h){var f=(h.nodeName&&h.nodeName.toLowerCase()=="input"?h:this);if(d._lastInput==f||d._isDisabledPlugin(f)){d._focussed=false;return}var g=e.data(f,d.propertyName);d._focussed=true;d._lastInput=f;d._blurredInput=null;e.extend(g.options,(e.isFunction(g.options.beforeShow)?g.options.beforeShow.apply(f,[f]):{}));d._parseTime(g);setTimeout(function(){d._showField(g)},10)},_doBlur:function(f){d._blurredInput=d._lastInput;d._lastInput=null},_doClick:function(g){var n=g.target;var j=e.data(n,d.propertyName);if(!d._focussed){var o=j.options.separator.length+2;j._field=0;if(n.selectionStart!=null){for(var m=0;m<=Math.max(1,j._secondField,j._ampmField);m++){var h=(m!=j._ampmField?(m*o)+2:(j._ampmField*o)+j.options.ampmPrefix.length+j.options.ampmNames[0].length);j._field=m;if(n.selectionStart<h){break}}}else{if(n.createTextRange){var f=e(g.srcElement);var k=n.createTextRange();var l=function(p){return{thin:2,medium:4,thick:6}[p]||p};var i=g.clientX+document.documentElement.scrollLeft-(f.offset().left+parseInt(l(f.css("border-left-width")),10))-k.offsetLeft;for(var m=0;m<=Math.max(1,j._secondField,j._ampmField);m++){var h=(m!=j._ampmField?(m*o)+2:(j._ampmField*o)+j.options.ampmPrefix.length+j.options.ampmNames[0].length);k.collapse();k.moveEnd("character",h);j._field=m;if(i<k.boundingWidth){break}}}}}d._showField(j);d._focussed=false},_doKeyDown:function(f){if(f.keyCode>=48){return true}var g=e.data(f.target,d.propertyName);switch(f.keyCode){case 9:return(f.shiftKey?d._changeField(g,-1,true):d._changeField(g,+1,true));case 35:if(f.ctrlKey){d._setValue(g,"")}else{g._field=Math.max(1,g._secondField,g._ampmField);d._adjustField(g,0)}break;case 36:if(f.ctrlKey){d._setTime(g)}else{g._field=0;d._adjustField(g,0)}break;case 37:d._changeField(g,-1,false);break;case 38:d._adjustField(g,+1);break;case 39:d._changeField(g,+1,false);break;case 40:d._adjustField(g,-1);break;case 46:d._setValue(g,"");break;default:return true}return false},_doKeyPress:function(g){var f=String.fromCharCode(g.charCode==undefined?g.keyCode:g.charCode);if(f<" "){return true}var h=e.data(g.target,d.propertyName);d._handleKeyPress(h,f);return false},_doMouseWheel:function(f,h){if(d._isDisabledPlugin(f.target)){return}h=(e.browser.opera?-h/Math.abs(h):(e.browser.safari?h/Math.abs(h):h));var g=e.data(f.target,d.propertyName);g.input.focus();if(!g.input.val()){d._parseTime(g)}d._adjustField(g,h);f.preventDefault()},_expandSpinner:function(f){var j=d._getSpinnerTarget(f);var h=e.data(d._getInput(j),d.propertyName);if(d._isDisabledPlugin(h.input[0])){return}if(h.options.spinnerBigImage){h._expanded=true;var i=e(j).offset();var g=null;e(j).parents().each(function(){var k=e(this);if(k.css("position")=="relative"||k.css("position")=="absolute"){g=k.offset()}return !g});e('<div class="'+d._expandClass+'" style="position: absolute; left: '+(i.left-(h.options.spinnerBigSize[0]-h.options.spinnerSize[0])/2-(g?g.left:0))+"px; top: "+(i.top-(h.options.spinnerBigSize[1]-h.options.spinnerSize[1])/2-(g?g.top:0))+"px; width: "+h.options.spinnerBigSize[0]+"px; height: "+h.options.spinnerBigSize[1]+"px; background: transparent url("+h.options.spinnerBigImage+') no-repeat 0px 0px; z-index: 10;"></div>').mousedown(d._handleSpinner).mouseup(d._endSpinner).mouseout(d._endExpand).mousemove(d._describeSpinner).insertAfter(j)}},_getInput:function(f){return e(f).siblings("."+d.markerClassName)[0]},_describeSpinner:function(f){var h=d._getSpinnerTarget(f);var g=e.data(d._getInput(h),d.propertyName);h.title=g.options.spinnerTexts[d._getSpinnerRegion(g,f)]},_handleSpinner:function(g){var j=d._getSpinnerTarget(g);var f=d._getInput(j);if(d._isDisabledPlugin(f)){return}if(f==d._blurredInput){d._lastInput=f;d._blurredInput=null}var h=e.data(f,d.propertyName);d._doFocus(f);var i=d._getSpinnerRegion(h,g);d._changeSpinner(h,j,i);d._actionSpinner(h,i);d._timer=null;d._handlingSpinner=true;if(i>=3&&h.options.spinnerRepeat[0]){d._timer=setTimeout(function(){d._repeatSpinner(h,i)},h.options.spinnerRepeat[0]);e(j).one("mouseout",d._releaseSpinner).one("mouseup",d._releaseSpinner)}},_actionSpinner:function(f,g){if(!f.input.val()){d._parseTime(f)}switch(g){case 0:this._setTime(f);break;case 1:this._changeField(f,-1,false);break;case 2:this._changeField(f,+1,false);break;case 3:this._adjustField(f,+1);break;case 4:this._adjustField(f,-1);break}},_repeatSpinner:function(f,g){if(!d._timer){return}d._lastInput=d._blurredInput;this._actionSpinner(f,g);this._timer=setTimeout(function(){d._repeatSpinner(f,g)},f.options.spinnerRepeat[1])},_releaseSpinner:function(f){clearTimeout(d._timer);d._timer=null},_endExpand:function(g){d._timer=null;var i=d._getSpinnerTarget(g);var f=d._getInput(i);var h=e.data(f,d.propertyName);e(i).remove();h._expanded=false},_endSpinner:function(g){d._timer=null;var i=d._getSpinnerTarget(g);var f=d._getInput(i);var h=e.data(f,d.propertyName);if(!d._isDisabledPlugin(f)){d._changeSpinner(h,i,-1)}if(d._handlingSpinner){d._lastInput=d._blurredInput}if(d._lastInput&&d._handlingSpinner){d._showField(h)}d._handlingSpinner=false},_getSpinnerTarget:function(f){return f.target||f.srcElement},_getSpinnerRegion:function(k,g){var p=this._getSpinnerTarget(g);var l=(e.browser.opera||e.browser.safari?d._findPos(p):e(p).offset());var h=(e.browser.safari?d._findScroll(p):[document.documentElement.scrollLeft||document.body.scrollLeft,document.documentElement.scrollTop||document.body.scrollTop]);var i=(k.options.spinnerIncDecOnly?99:g.clientX+h[0]-l.left-(e.browser.msie?2:0));var m=g.clientY+h[1]-l.top-(e.browser.msie?2:0);var n=k.options[k._expanded?"spinnerBigSize":"spinnerSize"];var o=(k.options.spinnerIncDecOnly?99:n[0]-1-i);var f=n[1]-1-m;if(n[2]>0&&Math.abs(i-o)<=n[2]&&Math.abs(m-f)<=n[2]){return 0}var j=Math.min(i,m,o,f);return(j==i?1:(j==o?2:(j==m?3:4)))},_changeSpinner:function(f,h,g){e(h).css("background-position","-"+((g+1)*f.options[f._expanded?"spinnerBigSize":"spinnerSize"][0])+"px 0px")},_findPos:function(h){var g=curTop=0;if(h.offsetParent){g=h.offsetLeft;curTop=h.offsetTop;while(h=h.offsetParent){var f=g;g+=h.offsetLeft;if(g<0){g=f}curTop+=h.offsetTop}}return{left:g,top:curTop}},_findScroll:function(h){var g=false;e(h).parents().each(function(){g|=e(this).css("position")=="fixed"});if(g){return[0,0]}var i=h.scrollLeft;var f=h.scrollTop;while(h=h.parentNode){i+=h.scrollLeft||0;f+=h.scrollTop||0}return[i,f]},_parseTime:function(h){var g=this._extractTime(h);if(g){h._selectedHour=g[0];h._selectedMinute=g[1];h._selectedSecond=g[2]}else{var f=this._constrainTime(h);h._selectedHour=f[0];h._selectedMinute=f[1];h._selectedSecond=(h.options.showSeconds?f[2]:0)}h._secondField=(h.options.showSeconds?2:-1);h._ampmField=(h.options.show24Hours?-1:(h.options.showSeconds?3:2));h._lastChr="";h._field=Math.max(0,Math.min(Math.max(1,h._secondField,h._ampmField),h.options.initialField));if(h.input.val()!=""){this._showTime(h)}},_extractTime:function(l,k){k=k||l.input.val();var j=k.split(l.options.separator);if(l.options.separator==""&&k!=""){j[0]=k.substring(0,2);j[1]=k.substring(2,4);j[2]=k.substring(4,6)}if(j.length>=2){var i=!l.options.show24Hours&&(k.indexOf(l.options.ampmNames[0])>-1);var f=!l.options.show24Hours&&(k.indexOf(l.options.ampmNames[1])>-1);var g=parseInt(j[0],10);g=(isNaN(g)?0:g);g=((i||f)&&g==12?0:g)+(f?12:0);var m=parseInt(j[1],10);m=(isNaN(m)?0:m);var h=(j.length>=3?parseInt(j[2],10):0);h=(isNaN(h)||!l.options.showSeconds?0:h);return this._constrainTime(l,[g,m,h])}return null},_constrainTime:function(l,f){var k=(f!=null);if(!k){var g=this._determineTime(l.options.defaultTime,l)||new Date();f=[g.getHours(),g.getMinutes(),g.getSeconds()]}var j=false;for(var h=0;h<l.options.timeSteps.length;h++){if(j){f[h]=0}else{if(l.options.timeSteps[h]>1){f[h]=Math.round(f[h]/l.options.timeSteps[h])*l.options.timeSteps[h];j=true}}}return f},_showTime:function(g){var f=(this._formatNumber(g.options.show24Hours?g._selectedHour:((g._selectedHour+11)%12)+1)+g.options.separator+this._formatNumber(g._selectedMinute)+(g.options.showSeconds?g.options.separator+this._formatNumber(g._selectedSecond):"")+(g.options.show24Hours?"":g.options.ampmPrefix+g.options.ampmNames[(g._selectedHour<12?0:1)]));this._setValue(g,f);this._showField(g)},_showField:function(j){var i=j.input[0];if(j.input.is(":hidden")||d._lastInput!=i){return}var f=j.options.separator.length+2;var k=(j._field!=j._ampmField?(j._field*f):(j._ampmField*f)-j.options.separator.length+j.options.ampmPrefix.length);var g=k+(j._field!=j._ampmField?2:j.options.ampmNames[0].length);if(i.setSelectionRange){i.setSelectionRange(k,g)}else{if(i.createTextRange){var h=i.createTextRange();h.moveStart("character",k);h.moveEnd("character",g-j.input.val().length);h.select()}}if(!i.disabled){i.focus()}},_formatNumber:function(f){return(f<10?"0":"")+f},_setValue:function(g,f){if(f!=g.input.val()){g.input.val(f).trigger("change")}},_changeField:function(g,i,h){var f=(g.input.val()==""||g._field==(i==-1?0:Math.max(1,g._secondField,g._ampmField)));if(!f){g._field+=i}this._showField(g);g._lastChr="";return(f&&h)},_adjustField:function(f,g){if(f.input.val()==""){g=0}this._setTime(f,new Date(0,0,0,f._selectedHour+(f._field==0?g*f.options.timeSteps[0]:0)+(f._field==f._ampmField?g*12:0),f._selectedMinute+(f._field==1?g*f.options.timeSteps[1]:0),f._selectedSecond+(f._field==f._secondField?g*f.options.timeSteps[2]:0)))},_setTime:function(i,j){j=this._determineTime(j,i);var f=this._constrainTime(i,j?[j.getHours(),j.getMinutes(),j.getSeconds()]:null);j=new Date(0,0,0,f[0],f[1],f[2]);var j=this._normaliseTime(j);var g=this._normaliseTime(this._determineTime(i.options.minTime,i));var h=this._normaliseTime(this._determineTime(i.options.maxTime,i));j=(g&&j<g?g:(h&&j>h?h:j));if(e.isFunction(i.options.beforeSetTime)){j=i.options.beforeSetTime.apply(i.input[0],[this._getTimePlugin(i.input[0]),j,g,h])}i._selectedHour=j.getHours();i._selectedMinute=j.getMinutes();i._selectedSecond=j.getSeconds();this._showTime(i)},_determineTime:function(h,i){var g=function(k){var j=new Date();j.setTime(j.getTime()+k*1000);return j};var f=function(q){var j=d._extractTime(i,q);var o=new Date();var k=(j?j[0]:o.getHours());var p=(j?j[1]:o.getMinutes());var l=(j?j[2]:o.getSeconds());if(!j){var n=/([+-]?[0-9]+)\s*(s|S|m|M|h|H)?/g;var m=n.exec(q);while(m){switch(m[2]||"s"){case"s":case"S":l+=parseInt(m[1],10);break;case"m":case"M":p+=parseInt(m[1],10);break;case"h":case"H":k+=parseInt(m[1],10);break}m=n.exec(q)}}o=new Date(0,0,10,k,p,l,0);if(/^!/.test(q)){if(o.getDate()>10){o=new Date(0,0,10,23,59,59)}else{if(o.getDate()<10){o=new Date(0,0,10,0,0,0)}}}return o};return(h?(typeof h=="string"?f(h):(typeof h=="number"?g(h):h)):null)},_normaliseTime:function(f){if(!f){return null}f.setFullYear(1900);f.setMonth(0);f.setDate(0);return f},_handleKeyPress:function(j,i){if(i==j.options.separator){this._changeField(j,+1,false)}else{if(i>="0"&&i<="9"){var m=parseInt(i,10);var l=parseInt(j._lastChr+i,10);var h=(j._field!=0?j._selectedHour:(j.options.show24Hours?(l<24?l:m):(l>=1&&l<=12?l:(m>0?m:j._selectedHour))%12+(j._selectedHour>=12?12:0)));var g=(j._field!=1?j._selectedMinute:(l<60?l:m));var f=(j._field!=j._secondField?j._selectedSecond:(l<60?l:m));var k=this._constrainTime(j,[h,g,f]);this._setTime(j,new Date(0,0,0,k[0],k[1],k[2]));if(j.options.noSeparatorEntry&&j._lastChr){this._changeField(j,+1,false)}else{j._lastChr=i}}else{if(!j.options.show24Hours){i=i.toLowerCase();if((i==j.options.ampmNames[0].substring(0,1).toLowerCase()&&j._selectedHour>=12)||(i==j.options.ampmNames[1].substring(0,1).toLowerCase()&&j._selectedHour<12)){var n=j._field;j._field=j._ampmField;this._adjustField(j,+1);j._field=n;this._showField(j)}}}}}});var c=["getOffset","getTime","isDisabled"];function b(g,f){if(g=="option"&&(f.length==0||(f.length==1&&typeof f[0]=="string"))){return true}return e.inArray(g,c)>-1}e.fn.timeEntry=function(g){var f=Array.prototype.slice.call(arguments,1);if(b(g,f)){return d["_"+g+"Plugin"].apply(d,[this[0]].concat(f))}return this.each(function(){if(typeof g=="string"){if(!d["_"+g+"Plugin"]){throw"Unknown command: "+g}d["_"+g+"Plugin"].apply(d,[this].concat(f))}else{var h=(e.fn.metadata?e(this).metadata():{});d._attachPlugin(this,e.extend(h,g||{}))}})};var d=e.timeEntry=new a()})(jQuery);